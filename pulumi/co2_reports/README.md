# CO2 Reports - Pulumi Infrastructure

Infrastructure-as-Code for the nf-core CO2 footprint reports S3 bucket using Pulumi.

## Overview

This Pulumi project creates and manages AWS infrastructure for storing CO2 footprint reports generated by nf-test runs in the nf-core/modules repository.

**Created Resources:**

- üì¶ S3 bucket `nf-core-co2-reports` (eu-north-1)
- üë§ IAM user `nf-core-co2-reports-ci` with write access
- üîë GitHub Actions secrets for nf-core/modules repository

## Quick Start

### Prerequisites

1. AWS credentials from 1Password (`Dev` vault ‚Üí `Pulumi-AWS-key`)
2. 1Password service account token
3. uv installed (`brew install uv` or similar)

### Deployment

```bash
# Set AWS credentials
export AWS_ACCESS_KEY_ID="<from 1Password>"
export AWS_SECRET_ACCESS_KEY="<from 1Password>"
export AWS_REGION="eu-north-1"

# Optional: Set 1Password token (or script will prompt)
export OP_SERVICE_ACCOUNT_TOKEN="<your token>"

# Run deployment script
cd ~/src/nf-core/ops/pulumi/co2_reports
./DEPLOY.sh
```

### Manual Deployment

If you prefer manual control:

```bash
cd ~/src/nf-core/ops/pulumi/co2_reports

# Initialize stack
uv run pulumi stack init AWSMegatests

# Configure
uv run pulumi config set aws:region eu-north-1
uv run pulumi config set github:owner nf-core
uv run pulumi config set pulumi-onepassword:service_account_token <TOKEN> --secret

# Deploy
uv run pulumi preview  # Preview changes
uv run pulumi up       # Deploy
```

## Infrastructure Details

### S3 Bucket

- **Name**: `nf-core-co2-reports`
- **Region**: `eu-north-1`
- **Encryption**: AES256 server-side encryption
- **Versioning**: Enabled
- **Public Access**: Blocked
- **Purpose**: Store CO2 footprint trace files from nf-test runs

### Report Organization

Reports are organized by:
```
s3://nf-core-co2-reports/
  ‚îî‚îÄ‚îÄ modules/
      ‚îî‚îÄ‚îÄ YYYY-MM-DD/
          ‚îî‚îÄ‚îÄ branch-name/
              ‚îî‚îÄ‚îÄ profile/
                  ‚îî‚îÄ‚îÄ shard/
                      ‚îú‚îÄ‚îÄ co2footprint_trace.txt
                      ‚îî‚îÄ‚îÄ co2footprint_trace_*.txt
```

### IAM Permissions

The CI user has permissions for:
- `s3:PutObject` - Upload reports
- `s3:GetObject` - Download reports (for verification)
- `s3:ListBucket` - List bucket contents
- `s3:GetBucketLocation` - Get bucket region

### GitHub Secrets

The following secrets are automatically created in the `nf-core/modules` repository:

- `CO2_REPORTS_AWS_ACCESS_KEY_ID`
- `CO2_REPORTS_AWS_SECRET_ACCESS_KEY`
- `CO2_REPORTS_AWS_REGION`

## Usage in GitHub Actions

After deployment, update your GitHub workflow:

```yaml
- name: Configure AWS credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    aws-access-key-id: ${{ secrets.CO2_REPORTS_AWS_ACCESS_KEY_ID }}
    aws-secret-access-key: ${{ secrets.CO2_REPORTS_AWS_SECRET_ACCESS_KEY }}
    aws-region: ${{ secrets.CO2_REPORTS_AWS_REGION }}

- name: Upload CO2 footprint reports to S3
  run: |
    aws s3 cp co2footprint_trace.txt s3://nf-core-co2-reports/...
```

## Management

### View Stack Outputs

```bash
cd ~/src/nf-core/ops/pulumi/co2_reports
uv run pulumi stack output
```

### Update Infrastructure

```bash
# Make changes to __main__.py
# Preview changes
uv run pulumi preview

# Apply changes
uv run pulumi up
```

### Destroy Infrastructure

```bash
# ‚ö†Ô∏è  WARNING: This will delete the bucket and all reports!
uv run pulumi destroy
```

## Project Structure

```
co2_reports/
‚îú‚îÄ‚îÄ Pulumi.yaml              # Project configuration
‚îú‚îÄ‚îÄ __main__.py              # Infrastructure definition
‚îú‚îÄ‚îÄ pyproject.toml           # Python dependencies
‚îú‚îÄ‚îÄ DEPLOY.sh               # Deployment script
‚îú‚îÄ‚îÄ README.md                # This file
‚îî‚îÄ‚îÄ .venv/                   # Virtual environment
```

## Troubleshooting

### Error: "operation error S3: GetObject"

This means Pulumi can't access the S3 backend. Ensure AWS credentials are set:

```bash
export AWS_ACCESS_KEY_ID="<your key>"
export AWS_SECRET_ACCESS_KEY="<your secret>"
```

### Error: "No such bookmark: AWSMegatests"

The stack hasn't been initialized yet. Run:

```bash
uv run pulumi stack init AWSMegatests
```

### GitHub Secrets Not Created

Check that:
1. The 1Password service account token is correct
2. The GitHub token in 1Password has proper permissions
3. The repository name is correct (`modules`, not `nf-core/modules`)

## Related Documentation

- [nf-co2footprint Plugin](https://github.com/nextflow-io/nf-co2footprint)
- [GitHub Issue #9291](https://github.com/nf-core/modules/issues/9291)
- [Pulumi AWS Documentation](https://www.pulumi.com/registry/packages/aws/)

## Support

For issues or questions:
- Open an issue in [nf-core/modules](https://github.com/nf-core/modules/issues)
- Contact the nf-core infrastructure team
